<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Brand PPI + Sell‑Through + Revenue CRM</title>
  <style>
    /*
      A simple bone/coffee/honey themed layout.
      The palette is inspired by natural materials with warm browns and off‑white backgrounds.
    */
    /*
      Enhanced pastel/3D style for a dream‑like aesthetic. Elements are given
      depth through layered shadows and soft gradients. A subtle animated
      background adds movement without distracting from the content.
    */
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      /* A repeating radial gradient creates a soft tiled pattern that slowly moves */
      background: radial-gradient(circle at 20% 20%, rgba(255, 226, 226, 0.6), rgba(255, 255, 255, 0.6) 40%, rgba(229, 235, 255, 0.6) 75%) fixed;
      background-size: 200% 200%;
      animation: moveBg 30s linear infinite;
      color: #4a2c2a;
      margin: 0;
      padding: 20px;
      scroll-behavior: smooth;
    }

    /* Slow moving background animation */
    @keyframes moveBg {
      0% { background-position: 0 0; }
      100% { background-position: 100% 100%; }
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .header h1 {
      margin: 0;
      font-size: 2em;
      color: #4a2c2a;
      text-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    /* KPI cards with gradients, rounded corners and layered shadows for a 3D look */
    .kpi-card {
      display: inline-block;
      background: linear-gradient(135deg, rgba(255, 250, 240, 0.9), rgba(255, 230, 237, 0.9));
      border-radius: 16px;
      padding: 14px 20px;
      margin: 8px;
      box-shadow:
        0 2px 4px rgba(0,0,0,0.1),
        0 6px 12px rgba(0,0,0,0.05),
        inset 0 0 8px rgba(255,255,255,0.5);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow:
        0 4px 8px rgba(0,0,0,0.15),
        0 10px 20px rgba(0,0,0,0.08),
        inset 0 0 10px rgba(255,255,255,0.6);
    }

    .kpi-card h2 {
      margin: 0;
      font-size: 0.75em;
      color: #5d4037;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .kpi-card p {
      margin: 8px 0 0;
      font-size: 1.4em;
      font-weight: bold;
      color: #4a2c2a;
    }

    /* Table styling with pastel hues and soft shadows */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 10px;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      border-radius: 12px;
      overflow: hidden;
    }

    th, td {
      padding: 12px 14px;
      text-align: left;
    }

    th {
      background: linear-gradient(180deg, #e1d5c8, #d2c2b5);
      color: #4a2c2a;
      font-weight: 600;
      font-size: 0.9em;
      position: sticky;
      top: 0;
      z-index: 1;
      /* Slight inner shadow */
      box-shadow: inset 0 -1px 0 rgba(255,255,255,0.3);
    }

    tbody tr {
      background: rgba(255,255,255,0.6);
      transition: background 0.3s ease;
      animation: fadeInUp 0.5s ease forwards;
    }

    tbody tr:nth-child(even) {
      background: rgba(249, 244, 241, 0.6);
    }

    tbody tr:hover {
      background: rgba(255, 248, 230, 0.9);
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Heatmap styles */
    .heatmap {
      display: block;
      width: 100%;
      border-radius: 12px;
      overflow-x: auto;
    }
    .heatmap-row {
      display: flex;
      align-items: stretch;
      margin-bottom: 2px;
    }
    .heatmap-header {
      font-weight: 600;
    }
    .heatmap-cell {
      flex: 1;
      min-width: 80px;
      padding: 8px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.3);
      font-size: 0.85em;
    }
    .heatmap-header-cell {
      background: rgba(230, 215, 200, 0.7);
      color: #4a2c2a;
      font-size: 0.9em;
    }
    .heatmap-name-cell {
      min-width: 120px;
      text-align: left;
      font-weight: 600;
      background: rgba(250, 240, 235, 0.8);
    }
    .heatmap-corner {
      background: rgba(250, 240, 235, 0.8);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 id="title">Brand PPI + Sell‑Through + Revenue CRM</h1>
    <div id="kpiContainer"></div>
  </div>
  <!-- Container for the heatmap. This replaces the previous table layout. -->
  <div id="heatmapContainer" style="margin-top: 20px;"></div>
  <script>
    /**
     * Load the JSON data and populate the dashboard.
     * Revenue share and BEI (Brand Efficiency Index) are computed client‑side.
     */
    async function loadData() {
      try {
        const response = await fetch('brand_ppi_crm_data.json');
        const data = await response.json();
        // Update title
        const meta = data.meta || {};
        document.getElementById('title').textContent = meta.title || 'Brand CRM';
        // KPI cards
        const kpiContainer = document.getElementById('kpiContainer');
        kpiContainer.innerHTML = '';
        const kpis = data.kpis || {};
        function addKpi(title, value) {
          const card = document.createElement('div');
          card.className = 'kpi-card';
          const h2 = document.createElement('h2');
          h2.textContent = title;
          const p = document.createElement('p');
          p.textContent = value;
          card.appendChild(h2);
          card.appendChild(p);
          kpiContainer.appendChild(card);
        }
        const toCurrency = (val) => {
          return '$' + Number(val || 0).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        };
        addKpi('Total Revenue', toCurrency(kpis.total_revenue));
        addKpi('Total Units', Number(kpis.total_units || 0).toLocaleString());
        // Build heatmap data
        const brands = data.brands || [];
        // Compute total revenue for revenue share
        let totalRevenue = Number(kpis.total_revenue || 0);
        if (!totalRevenue) {
          totalRevenue = brands.reduce((acc, b) => acc + (b.revenue || 0), 0);
        }
        // Prepare metrics per brand
        // Compute revenue share and BEI
        brands.forEach((b) => {
          const share = totalRevenue > 0 ? ((b.revenue || 0) / totalRevenue) : 0;
          b.revenue_share = share;
          // compute BEI: (Revenue Share / PPI Index) * Sell-Through * 100
          if (b.ppi_index && b.sell_through_pct !== undefined) {
            const beiRaw = (share * 100) / b.ppi_index * b.sell_through_pct;
            b.bei = beiRaw;
          } else {
            b.bei = 0;
          }
        });
        // Define metrics we will visualize in the heatmap
        const metrics = [
          { key: 'ppi_index', label: 'PPI', invert: false },
          { key: 'sell_through_pct', label: 'Sell-Through', invert: false },
          { key: 'revenue_share', label: 'Revenue Share', invert: false },
          { key: 'bei', label: 'BEI', invert: false }
        ];
        // Compute min/max for each metric
        const ranges = metrics.map(m => {
          const values = brands.map(b => {
            const val = b[m.key];
            return val !== undefined && val !== null ? Number(val) : 0;
          });
          const min = Math.min(...values);
          const max = Math.max(...values);
          return { min, max };
        });
        // Create heatmap elements
        const heatmapContainer = document.getElementById('heatmapContainer');
        heatmapContainer.innerHTML = '';
        heatmapContainer.className = 'heatmap';
        // Header row for metric labels
        const headerRow = document.createElement('div');
        headerRow.className = 'heatmap-row heatmap-header';
        // empty corner cell
        const corner = document.createElement('div');
        corner.className = 'heatmap-cell heatmap-corner';
        corner.textContent = '';
        headerRow.appendChild(corner);
        metrics.forEach((m) => {
          const cell = document.createElement('div');
          cell.className = 'heatmap-cell heatmap-header-cell';
          cell.textContent = m.label;
          headerRow.appendChild(cell);
        });
        heatmapContainer.appendChild(headerRow);
        // For each brand create row
        brands.forEach((b) => {
          const row = document.createElement('div');
          row.className = 'heatmap-row';
          // brand name cell
          const nameCell = document.createElement('div');
          nameCell.className = 'heatmap-cell heatmap-name-cell';
          nameCell.textContent = b.brand;
          row.appendChild(nameCell);
          // cells for each metric
          metrics.forEach((m, idx) => {
            const val = b[m.key];
            const { min, max } = ranges[idx];
            // Normalize value between 0 and 1
            let ratio = 0;
            if (max > min) {
              ratio = (val - min) / (max - min);
            }
            // Choose color: map ratio to pastel scale (higher = darker) with a fixed hue
            const hue = 10; // soft coral hue
            const lightness = 95 - 35 * ratio; // 95% (light) to 60% (dark)
            const backgroundColor = `hsl(${hue}, 80%, ${lightness}%)`;
            const cell = document.createElement('div');
            cell.className = 'heatmap-cell';
            cell.style.backgroundColor = backgroundColor;
            // Tooltip on hover
            const displayVal = m.key === 'revenue_share' ? (val * 100).toFixed(1) + '%' : (m.key === 'sell_through_pct' ? (val * 100).toFixed(1) + '%' : val.toFixed(1));
            cell.title = `${b.brand} — ${m.label}: ${displayVal}`;
            row.appendChild(cell);
          });
          heatmapContainer.appendChild(row);
        });
      } catch (err) {
        console.error('Failed to load data:', err);
      }
    }
    // Load data on page load
    loadData();
  </script>
</body>
</html>